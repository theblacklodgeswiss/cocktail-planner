rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    // Super Admin email - can only manage users, not data
    function isSuperAdmin() {
      return request.auth != null && request.auth.token.email == 'the.blacklodge@outlook.com';
    }
    
    // Check if user is admin via allowedUsers collection
    function isAdminFromCollection() {
      return request.auth != null && 
             exists(/databases/$(database)/documents/allowedUsers/$(request.auth.token.email)) &&
             get(/databases/$(database)/documents/allowedUsers/$(request.auth.token.email)).data.isAdmin == true;
    }
    
    // Full data admin (NOT including super admin)
    function isAdmin() {
      return isAdminFromCollection();
    }

    // Can manage users: full admin OR super admin
    function canManageUsers() {
      return isSuperAdmin() || isAdminFromCollection();
    }
    
    // Authenticated users (including anonymous)
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Materials collection
    match /materials/{document=**} {
      allow read: if true;
      allow write: if isAdmin();
    }
    
    // Recipes collection
    match /recipes/{document=**} {
      allow read: if true;
      allow write: if isAdmin();
    }
    
    // Fixed values collection
    match /fixedValues/{document=**} {
      allow read: if true;
      allow write: if isAdmin();
    }
    
    // Orders collection - all authenticated users can read/write their own
    match /orders/{orderId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update, delete: if isAdmin() || resource.data.userId == request.auth.uid;
    }
    
    // Users collection - for user profiles
    match /users/{userId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated() && request.auth.uid == userId;
      allow update: if request.auth.uid == userId || isAdmin();
      allow delete: if isAdmin();
    }
    
    // Allowed users collection - super admin can create; full admins can create/update/delete
    match /allowedUsers/{email} {
      allow read: if isAuthenticated();
      allow create: if canManageUsers();
      allow update, delete: if isAdmin();
    }
    
    // Admin config - only admin can read/write
    match /config/{document=**} {
      allow read: if isAdmin();
      allow write: if isAdmin();
    }
    
    // Settings collection - all authenticated can read, only admin can write
    match /settings/{document=**} {
      allow read: if isAuthenticated();
      allow write: if isAdmin();
    }
  }
}
